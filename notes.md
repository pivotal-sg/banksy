EventSourcing (our take on ES!) ... some notes on architecture ...

- An aggregate is a representations of an entity, or group of tightly interrelated entities.
- ~~Aggregates may publish events (not dispatch commands)~~ UNTRUE - Aggregates do NOT publish events
- dispatcher of a Command receives a CommandResult<T>
- Event Publishing does NOT generate an EventResult<T>
- Communication directly between Aggregates IS ILLEGAL!
- Aggregates apply events after publishing them to the Event Log

# Major components

- **AccountCommandDispatcher**
    - Resposibilities
        - dispatch commands to the AccountService
    - Collaborators
        - AccountService

- **AccountService**
    - Resposibilities
        - ensure command values are wellformed
        - Keep Account Aggregates updated
        - Persist new events and apply them to the aggregate
    - Collaborators
        - AccountRepo
        - EventBus
        - EventStore

- **AccountRepository**
    - Resposibilities
        - get/save account aggregate

    - Collaborators
        - AccountAggregate

- **AccountAggregate**
    - Resposibilities
        - validates the business logic content of a command
        - apply events

- **AccountQueryService**
    - Resposibilities
        - (write side of Query system)
        - Build (or rebuild) persisted queryable data set(s) derived from Event input
    - Collaborators
        - EventBus

- **QueryDispatcher**
    - Resposibilities
        - (read side of Query system)
        -
    - Collaborators
        - (future role) Projections (a variety of queryable datasets)

- **EventStore**
    - Resposibilities
        - Log events
    - Collaborators
        - EventBus

- **EventBus**
    - Resposibilities
        - subscribe events
        - publish events

    - Collaborators
        - Publishers (generic event publish behavior/role)
        - Subscribers (generic event subscription behavior/role)

# Spec

- [x] Create account
    - [x] Set balance to 0
    - [x] Get account number in result of command
    - [x] Indicate success

    - [x] command is executed
        - [x] uuid (account number) will be generated by the command
        - [x] AccountCreated Event is built and published
        - [x] results are returned to caller

- [x] View account / balance
    - [x] Show top level account details

- [x] Credit Account
    - [x] Validate positive credit amount
    - [x] Show success/fail
    - [x] AccountCredited Event is built and published
    - [x] Querying shows the account balance has changed

- [x] Debit Account
    - [x] Validate positive debit amount
    - [x] Show success/fail
    - [x] AccountDebited Event is built and published

- [x] Overdraft facility
    - [x] Validate debits are within overdraft limit
    - [x] Fix application and validation via aggregate

- [ ] AccountEvent superclass
    - [x] has a uuid
    - [x] has a created at datetime

- [ ] DRY business logic
    - [x] Debit logic is done in one place only
    - [x] Credit logic is done in one place only

- [ ] Batch jobs
    - [ ] Charge monthly interest on Overdraft (at EOM)
        - [x] set account overdraft limit - command/event?
        - [x] get all accounts which are overdrawn (ie. negative balance)
        - [ ] trigger command using Spring batch
        - [ ] only charge once per month / per account
    - [ ] Pay annual interest on funds in credit (at EOM)
        - [x] get all accounts which are in credit
        - [ ] trigger command using Spring batch
        - [ ] only credit once per month / per account

### Deferred implementation...

- [ ] Transfer from Account A to Account B
- [ ] Add JSON RPC controller

# Tools

- [Kotlin](https://kotlinlang.org)
- [KSpec](https://github.com/dam5s/kspec) RSpec style testing for Kotlin
